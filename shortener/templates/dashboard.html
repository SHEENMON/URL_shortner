{% extends 'layout/app-layout.html' %}
{% block 'content' %}

<div class="container my-5">
    <header class="d-flex justify-content-between align-items-center mb-4">
        <h1>Welcome, {{ user.username }}</h1>
        <a href="{% url 'logout' %}" class="btn btn-danger">Logout</a>
    </header>

    <div class="mb-4">
        <input type="text" id="search" class="form-control" placeholder="Search URLs...">
        <div id="results" class="mt-3"></div>
    </div>

    <form method="post" action="{% url 'add_url' %}" class="card p-3 mb-4">
        {% csrf_token %}
        <h4>Add New URL</h4>
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" id="title" name="title" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="original_url" class="form-label">URL</label>
            <input type="url" id="original_url" name="original_url" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Add URL</button>
        {% if error %}
        <p class="text-danger mt-2">{{ error }}</p>
        {% endif %}
    </form>

    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Title</th>
                <th>Short URL</th>
                <th>Added Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for url in urls %}
            <tr>
                <td>{{ url.title }}</td>
                <td><a href="{% url 'redirect_to_url' url.short_url %}" target="_blank">{{ url.short_url }}</a></td>
                <td>{{ url.added_time }}</td>
                <td>
                    <a href="{% url 'edit_url' url.id %}" class="btn btn-warning btn-sm">Edit</a>
                    <a href="{% url 'delete_url' url.id %}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this URL?');">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <nav class="d-flex justify-content-between align-items-center">
        <div>
            {% if urls.has_previous %}
            <a href="?page={{ urls.previous_page_number }}" class="btn btn-outline-primary btn-sm">Previous</a>
            {% endif %}
        </div>
        <span>Page {{ urls.number }} of {{ urls.paginator.num_pages }}</span>
        <div>
            {% if urls.has_next %}
            <a href="?page={{ urls.next_page_number }}" class="btn btn-outline-primary btn-sm">Next</a>
            {% endif %}
        </div>
    </nav>
</div>

<script>
document.getElementById('search').addEventListener('input', function() {
    const query = this.value;
    fetch(`/search/?query=${query}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            data.urls.forEach(url => {
                const div = document.createElement('div');
                div.innerHTML = `<p>${url.title} - <a href="${url.short_url}" target="_blank">${url.short_url}</a></p>`;
                resultsDiv.appendChild(div);
            });
        });
});
</script>

{% endblock %}
